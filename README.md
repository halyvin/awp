AWP
===

Приложение управления заявками сервиса техобслуживания.


Installation
------------

После клонирования репозитория следует:

1. создать файл config/database.yml и добавить в него следующее содержание:

        development:
          adapter: sqlite3
          database: db/development.sqlite3
          pool: 5
          timeout: 5000

2. выполнить команду `bundle install`
3. выполнить команду `bundle exec rake db:create db:migrate db:seed`
4. запустить сервер командой `bundle exec rails s`
5. зайти в браузере на адрес [http://localhost:3000](http://localhost:3000)
6. по завершению работы нужно погасить сервер - зайти в терминал, где выполнялась команда запуска сервера и остановить его сочетанием клавиш 'Ctrl + C'.

Пункты с 4 по 6 повторяются при каждой сессии работы с приложением.

В последствии можно сбросить все данные из БД на данные по умолчанию (пользователь admin с паролем master и список рабочих) с помощью команды `bundle exec rake db:drop db:create db:migrate db:seed`. Так же эту команду стоит выполнять каждый раз, когда меняются миграции.

Последний раз миграции менялись **6 октября 2013, 14:34**.


Frontend editing
----------------

Для редактирования фронтэнда я укажу расположение js, css, image файлов, а так же представлений - html страниц со вставками ruby кода.

### Javascript

Все js файлы хранятся в двух местах:

- vendor/assets/javascripts - библиотеки и плагины
- app/assets/javascripts - js код, написанный для проекта

При редактировании названия любого js файла, или добавлении нового в любую из папок, нужно зайти в файл app/assets/javascripts/application.js и или добавить строчку типа `//= require jquery.popapilus` с названием добавленного файла или найти строку с названием измененного файла и поправить её.

### CSS

Все css файлы хранятся в двух местах:

- vendor/assets/stylesheets - библиотеки
- app/assets/stylesheets - стили, написанные для проекта

При редактировании названия любого css файла, или добавлении нового в любую из папок, нужно зайти в файл app/assets/stylesheets/application.css и или добавить строчку типа `*= require popapilus` с названием добавленного файла или найти строку с названием измененного файла и поправить её.

### Images

Все изображения в app/assets/images. Никаких лишних действий не нужно - добавил и они уже в проекте.

### Статичные файлы

Обращаться к любому css, js файлу или файлу изображения можно и из статических html файлов, таки, например, как public/ex_index.html. После запуска приложения все css, js и файлы изображений какбэ переносятся в виртуальную папку /assets. Так что можно обратиться за файлом main.js по ссылке '/assets/main.js'. Так же в файле стилей когда подключаешь изображение через url() нужно обращаться не к '../images/file.png', а просто к 'file.png' -  виртуально они в одной папаке.

### Представления

Все представления хранятся в app/views. Внутри представлений в тэге `<% ... %>` размещается Ruby код - трогать его не рекомендуется.

- views/layouts/application.html.erb - обертка (head + header)
- views/requests/index.html.erb - главная
- views/requests/history.html.erb - страница истории заявок
- views/requests/print.html.erb - печать заявок
- views/requests/_workers_list.html.erb - фрагмент кода для списка работников (вставляется в index.html.erb с помощью команды `render partial: "workers_list"`.
- views/cabinet/edit.html.erb - настройки пользователя (личный кабинет)
- views/devise/sessions/new.html.erb - окно логина в систему


JSON API
--------

**GET /requests/{ID заявки}.json**

Получение данных о заявке. Пример возвращаемого значения:

    {
      "id":1,
      "user":"admin",
      "day":"2013-10-07",
      "time":"с 10 до 14",
      "body":"Переобжать линк и свести с ума всех прохожих",
      "address":"ул.Менжинского д.10 кв.195",
      "workers":[["Толик",1],["Ванька",2]]
    }

Если заяки с таким ID надено не будет - вернется 404 ошибка.

ID заявки можно взять из аттрибута `data-request-id` тэга `tr` строки таблицы с данными об этой заявке.

**POST /requests.json**

Создание нового запроса. Пример принимаемых данных:

    "request":{
      "day":"2013-10-07",
      "time":"с 10 до 14",
      "body":"Переобжать линк и свести с ума всех прохожих",
      "address":"ул.Менжинского д.10 кв.195",
      "worker_ids":[1,2]
    }

Пример возвращаемого значения в случае успеха:

    { id: 5 }

В случае ошибки вернется страница с кодом ошибки 422 и данными вроде:

    {
      "user":["не может быть пустым"],
      "day":["не может быть пустым"]
    }

**PUT /requests/{ID заявки}.json**

Обновление данных о заявке. Пример принимаемых данных:

    "request":{
      "id":1,
      "day":"2013-10-07",
      "time":"с 10 до 14",
      "body":"Переобжать линк и свести с ума всех прохожих",
      "address":"ул.Менжинского д.10 кв.195",
      "worker_ids":[1,2]
    }

Любой из параметров можно просто пропустить, если его не нужно обновлять. Для отправки запроса метода put достаточно просто передать jquery ajax в опции параметр `method: "put"`.

Возвращает ничего (точнее код 200) в случае успеха и ошибку с кодом 422, когда что-то пошло нет так, и данными вроде:

    {
      "user":["не может быть пустым"],
      "day":["не может быть пустым"]
    }

**DELETE /requests/{ID заявки}.json**

Удаление заявки. Восстановлению не подлежит. Для отправки запроса метода delete достаточно просто передать jquery ajax в опции параметр `method: "delete"`. Возвращает ничего (точнее код 200).

**Закрытие заявки пока еще не готово**


Comments
--------

Не стесняйся говорить о каких-то моментах, которые нужно доделать.
Я многие вещи не делаю, ибо не знаю, стоит ли на них тратить время.
Например, валидация email.
